<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="ChatHistoryState">
    <option name="chatSessions" value="{&quot;6af22e56-3fcb-4fed-8c28-1b93d40750af&quot;:{&quot;id&quot;:&quot;6af22e56-3fcb-4fed-8c28-1b93d40750af&quot;,&quot;name&quot;:&quot;CommandManager memory leaks and optimization in Kotlin&quot;,&quot;timestamp&quot;:1760359228434,&quot;messages&quot;:[{&quot;role&quot;:&quot;user&quot;,&quot;content&quot;:[{&quot;type&quot;:&quot;text&quot;,&quot;text&quot;:&quot;\n\u003cadditional_data\u003e\nBelow are some potentially helpful/relevant pieces of information for figuring out to respond\n\u003ccurrent_file\u003e\n```kotlin:src/main/kotlin/CommandManager.kt, lines\u003dALL(1-92)\npackage nick.mirosh\n\nimport kotlinx.coroutines.CoroutineScope\nimport kotlinx.coroutines.Dispatchers\nimport kotlinx.coroutines.flow.MutableSharedFlow\nimport kotlinx.coroutines.flow.asSharedFlow\nimport kotlinx.coroutines.launch\nimport nick.mirosh.networking.TelegramApiManager\nimport nick.mirosh.repository.TransactionRepo\nimport nick.mirosh.utils.Category\nimport org.telegram.telegrambots.meta.api.objects.Message\nimport java.time.LocalDate\nimport java.time.ZoneId\n\nconst val WEEKLY_STATUS_COMMAND \u003d \&quot;weekly_status\&quot;\nconst val SET_BUDGET_COMMAND \u003d \&quot;set_budget\&quot;\n\nclass CommandManager(\n    private val transactionRepo: TransactionRepo,\n    private val telegramApiManager: TelegramApiManager,\n) {\n    private val _showKeyboard \u003d MutableSharedFlow\u003cLong\u003e()\n    val showKeyboard \u003d _showKeyboard.asSharedFlow()\n\n    private val _showError \u003d MutableSharedFlow\u003cPair\u003cLong, String\u003e\u003e()\n    val showError \u003d _showError.asSharedFlow()\n\n    fun processCommand(message: Message) {\n        val command \u003d message.text.lowercase()\n        val chatId \u003d message.chatId\n        when {\n            command.contains(WEEKLY_STATUS_COMMAND) -\u003e\n                CoroutineScope(Dispatchers.Default).launch {\n                    _showKeyboard.emit(chatId)\n                }\n\n            command.contains(SET_BUDGET_COMMAND) -\u003e setBudget()\n\n            else -\u003e {\n            }\n        }\n    }\n\n    fun sendWeeklyReport(chatId: Long, category: Category) {\n        CoroutineScope(Dispatchers.IO).launch {\n            try {\n                val weeklyTransactions \u003d transactionRepo.getCurrentWeekTransactions()\n                val budgets \u003d transactionRepo.getBudgets()\n                val transactionsForCategory \u003d weeklyTransactions.filter { it.category \u003d\u003d category }\n                val totalMoneySpentForTheWeek \u003d transactionsForCategory.sumOf { it.sum }\n\n                val budget \u003d budgets.first { it.category \u003d\u003d category }\n                val calculatedWeekBudget \u003d calculateThisWeekBudget(budget.amountForMonth)\n\n                val moneyLeft \u003d calculatedWeekBudget - totalMoneySpentForTheWeek\n\n                val report \u003d Report(\n                    moneyLeft \u003d moneyLeft,\n                    weekBudget \u003d calculatedWeekBudget,\n                    category \u003d category\n                )\n                telegramApiManager.sendPhoto(chatId, report)\n            } catch (e: Exception) {\n                val message \u003d \&quot;Failed to send weekly report: ${e.message}\&quot;\n                _showError.emit(chatId to message)\n            }\n        }\n    }\n\n    data class Report(\n        val moneyLeft: Int,\n        val weekBudget: Int,\n        val category: Category\n    )\n\n\n    fun getWeeksInCurrentMonth(): Float {\n        val zone \u003d ZoneId.of(\&quot;Asia/Bangkok\&quot;)\n        val today \u003d LocalDate.now(zone)\n        val lastOfMonth \u003d today.withDayOfMonth(today.lengthOfMonth())\n\n        val totalDaysInMonth \u003d lastOfMonth.dayOfMonth\n        return totalDaysInMonth / 7.0f\n    }\n\n    private fun setBudget() {\n        CoroutineScope(Dispatchers.IO).launch {\n            transactionRepo.setHardCodedBudgets()\n        }\n    }\n}\n\n```\n\u003c/current_file\u003e\n\u003c/additional_data\u003e\n\u003cuser_query\u003e\nPlease analyze the project and determine where I have potential memory leaks and memory can be optimized\n\u003c/user_query\u003e&quot;}]},{&quot;role&quot;:&quot;assistant&quot;,&quot;content&quot;:[]}]}}" />
  </component>
</project>